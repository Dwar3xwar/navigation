<!DOCTYPE html>
<html>
<head>
    <title>Navigation Cycle</title>
    <style>
        table{border-collapse:collapse;}table,td,th{border:1px #000 solid;}
        ul{list-style-type:none;padding:0;margin:0;}li{float:left;padding-right:3px;}
        .active{font-weight:bold;}
    </style>
</head>
<body>
    <div id="content"></div>
    <script src="../../NavigationJS/sample/personSearch.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.0.6/rx.all.js"></script>
    <script src="https://rawgit.com/cyclejs/cycle-core/master/dist/cycle.js"></script>
    <script src="https://rawgit.com/cyclejs/cycle-dom/master/dist/cycle-dom.js"></script>
    <script src="https://rawgit.com/cyclejs/isolate/master/dist/cycle-isolate.js"></script>
    <script src="../../build/dist/navigation.js"></script>
    <script>
        var h = CycleDOM.h;
        
        Navigation.StateInfoConfig.build([
            { key: 'person', initial: 'list', states: [
                { key: 'list', route: '{startRowIndex}/{maximumRows}/{sortExpression}', defaults: { startRowIndex: 0, maximumRows: 10, sortExpression: 'Name'}, trackCrumbTrail: false, title: 'Person Search', transitions: [
                    { key: 'select', to: 'details' }]},
                { key: 'details', route: 'person', title: 'Person Details', }]}
        ]);
        
        var personDialog = Navigation.StateInfoConfig.dialogs.person;

        var listState = personDialog.states.list;        
        listState.intent = (sources) => sources.Navigation
            .map((navigated) => ({ 
                people: personSearch.search(),
                maximumRows: navigated.data.maximumRows
            }));
        listState.model = (data$) => data$.map(data => data.people.slice(0, data.maximumRows));
        listState.main = (sources) => {
            var people$ = listState.model(listState.intent(sources));
            return {
                DOM: people$.map(people => h('div', [
                    h('table', [
                        h('tr', [
                            h('th', 'Name'),
                            h('th', 'Date of Birth')                            
                        ])]
                        .concat(people.map(person =>
                        h('tr', [
                            h('td', [
                                navigationLink({
                                    action: 'select',
                                    data: { id: person.id }
                                }, person.name)
                            ]),
                            h('td', person.dateOfBirth)
                        ])))
                    )
                ]))
            };
        };
        
        var detailsState = personDialog.states.details;
        detailsState.intent = (sources) => sources.Navigation
            .map((navigated) => personSearch.getDetails(navigated.data.id));
        detailsState.model = (person$) => person$;        
        detailsState.main = (sources) => {
            var person$ = detailsState.model(detailsState.intent(sources));
            return {
                DOM: person$.map(person => h('div', [
                    navigationBackLink({ distance: 1}, 'Person Search'),
                    h('div', [
                        h('span', 'Name:' + person.name),
                        h('br'),
                        h('span', 'Date of birth:' + person.dateOfBirth)
                    ])
                ]))
            };
        };
        
        function main(sources) {
            var navigated$ = sources.Navigation
                .map((navigated) => navigated.state.main({ 
                    DOM: sources.DOM,
                    Navigation: sources.Navigation
                        .filter(subNavigated => navigated.state === subNavigated.state)
                }));
            return {
                DOM: navigated$.map(main => h('div', [
                    h('h1', 'Navigation Cycle'),
                    main.DOM
                ])),
                Navigation: sources.DOM.select('a').events('click')
            };
        }
        
        function NavigationDriver(navigate$) {
            navigate$.subscribe(e => {
                if (!e.ctrlKey && !e.shiftKey && !e.metaKey && !e.altKey && !e.button) {
                    var link = Navigation.settings.historyManager.getUrl(e.target);
                    Navigation.StateController.navigateLink(link);
                }
            });
            var navigated$ = new Rx.BehaviorSubject();
            for(var dialogKey in Navigation.StateInfoConfig.dialogs) {
                var dialog = Navigation.StateInfoConfig.dialogs[dialogKey];
                for(var stateKey in dialog.states) {
                    ((state) => state.navigated = (data) => {
                        navigated$.onNext({ 
                            state: state,
                            data: data
                        });
                    })(dialog.states[stateKey]);
                }
            }
            Navigation.start();
            return navigated$;
        }
        
        function navigationLink(attributes, children) {
            var newAttributes = {};
            var link = Navigation.StateController.getNavigationLink(attributes.action, attributes.data);
            newAttributes.href = Navigation.settings.historyManager.getHref(link);
            return h('a', newAttributes, children);
        }
        
        function navigationBackLink(attributes, children) {
            var newAttributes = {};
            var link = Navigation.StateController.getNavigationBackLink(attributes.distance);
            newAttributes.href = Navigation.settings.historyManager.getHref(link);
            return h('a', newAttributes, children);
        }

        Cycle.run(main, {
            DOM: CycleDOM.makeDOMDriver('#content'),
            Navigation: NavigationDriver
        });        
    </script>
</body>
</html>
