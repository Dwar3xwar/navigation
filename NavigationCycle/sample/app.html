<!DOCTYPE html>
<html>
<head>
    <title>Navigation Cycle</title>
    <style>
        table{border-collapse:collapse;}table,td,th{border:1px #000 solid;}
        ul{list-style-type:none;padding:0;margin:0;}li{float:left;padding-right:3px;}
        .active{font-weight:bold;}
    </style>
</head>
<body>
    <div id="content"></div>
    <script src="../../NavigationJS/sample/personSearch.js"></script>
    <script src="rx.all.js"></script>
    <script src="cycle.js"></script>
    <script src="cycle-dom.js"></script>
    <script src="cycle-isolate.js"></script>
    <script src="../../build/dist/navigation.js"></script>
    <script>
        var table = CycleDOM.table, tr = CycleDOM.tr, th = CycleDOM.th, td = CycleDOM.td, a = CycleDOM.a,
            ul = CycleDOM.ul, li = CycleDOM.li, div = CycleDOM.div, span = CycleDOM.span, br = CycleDOM.br;
        
        Navigation.StateInfoConfig.build([
            { key: 'person', initial: 'list', states: [
                { key: 'list', route: '{startRowIndex}/{maximumRows}/{sortExpression}', defaults: { startRowIndex: 0, maximumRows: 10, sortExpression: 'Name'}, trackCrumbTrail: false, title: 'Person Search', transitions: [
                    { key: 'select', to: 'details' }]},
                { key: 'details', route: 'person', title: 'Person Details', }]}
        ]);
        
        var personDialog = Navigation.StateInfoConfig.dialogs.person;

        var listState = personDialog.states.list;        
        listState.intent = (sources) => sources.Navigation
            .map((navigated) => ({ 
                people: personSearch.search(null, navigated.data.sortExpression),
                startRowIndex: navigated.data.startRowIndex,
                maximumRows: navigated.data.maximumRows,
                sortExpression: navigated.data.sortExpression
            })
        );
        listState.model = (data$) => (
            data$.map(data => {
                var totalRowCount = data.people.length;
                var remainder = totalRowCount % data.maximumRows;
                var previous = Math.max(0, data.startRowIndex - data.maximumRows);
                var next = data.startRowIndex + data.maximumRows;
                var last = remainder != 0 ? totalRowCount - remainder : totalRowCount - data.maximumRows;
                if (next >= totalRowCount)
                    next = last = data.startRowIndex;
                var people = data.people.slice(data.startRowIndex, data.startRowIndex + data.maximumRows);
                var sortExpression = data.sortExpression.indexOf('DESC') === -1 ? 'Name DESC' : 'Name';
                return {
                    people: people,
                    sortExpression: sortExpression,
                    previous: previous,
                    next: next,
                    last: last
                }
            })
        );
        listState.view = (data$) => (
            data$.map(data => div([
                div([
                    span('Page size '),
                    refreshLink({ toData: { maximumRows: 5, startRowIndex: null }, includeCurrentData: true }, '5'), span(' '),
                    refreshLink({ toData: { maximumRows: 10, startRowIndex: null }, includeCurrentData: true }, '10')
                ]),
                table([
                    tr([
                        th([ refreshLink({ toData: { sortExpression: data.sortExpression }, includeCurrentData: true }, 'Name') ]),
                        th('Date of Birth')                            
                    ])]
                    .concat(data.people.map(person =>
                    tr([
                        td([ navigationLink({ action: 'select', toData: { id: person.id }}, person.name) ]),
                        td(person.dateOfBirth)
                    ])))
                ),
                ul([
                    li([ refreshLink({ toData: { startRowIndex: 0 }, includeCurrentData: true }, 'First') ]),
                    li([ refreshLink({ toData: { startRowIndex: data.previous }, includeCurrentData: true }, 'Previous') ]),
                    li([ refreshLink({ toData: { startRowIndex: data.next }, includeCurrentData: true }, 'Next') ]),
                    li([ refreshLink({ toData: { startRowIndex: data.last }, includeCurrentData: true }, 'Last') ])
                ])
            ]))
        );
        listState.component = (sources) => {
            var vtree$ = listState.view(listState.model(listState.intent(sources)));
            return {
                DOM: vtree$,
                Navigation: sources.DOM.select('a').events('click')
            }
        };
        
        var detailsState = personDialog.states.details;
        detailsState.intent = (sources) => sources.Navigation
            .map((navigated) => personSearch.getDetails(navigated.data.id));
        detailsState.model = (person$) => person$;   
        detailsState.view = (person$) => (
            person$.map(person => div([
                navigationBackLink({ distance: 1 }, 'Person Search'),
                div([
                    span('Name:' + person.name), br(),
                    span('Date of birth:' + person.dateOfBirth)
                ])
            ]))
        );
        detailsState.component = (sources) => {
            var vtree$ = detailsState.view(detailsState.model(detailsState.intent(sources)));
            return {
                DOM: vtree$,
                Navigation: sources.DOM.select('a').events('click')
            }
        };
        
        function main(sources) {
            var component$$ = sources.Navigation
                .map((navigated) => {
                    var key = navigated.state.parent.index + '-' + navigated.state.index;
                    return CycleIsolate(navigated.state.component, key)(sources);
                });
            return {
                DOM: component$$.map((component) => component.DOM).switch(),
                Navigation: component$$.map((component) => component.Navigation).switch()
            };
        }
        
        function NavigationDriver(navigate$) {
            navigate$.subscribe(e => {
                if (!e.ctrlKey && !e.shiftKey && !e.metaKey && !e.altKey && !e.button) {
                    e.preventDefault();
                    var link = Navigation.settings.historyManager.getUrl(e.target);
                    Navigation.StateController.navigateLink(link);
                }
            });
            var navigated$ = new Rx.BehaviorSubject();
            for(var dialogKey in Navigation.StateInfoConfig.dialogs) {
                var dialog = Navigation.StateInfoConfig.dialogs[dialogKey];
                for(var stateKey in dialog.states) {
                    ((state) => state.navigated = (data) => {
                        navigated$.onNext({ 
                            state: state,
                            data: data
                        });
                    })(dialog.states[stateKey]);
                }
            }
            Navigation.start();
            navigated$.isolateSource = (NavigationSource, key) => (
                NavigationSource.filter((navigated) => navigated.state.parent.index + '-' + navigated.state.index === key)
            )
            return navigated$;
        }

        function getData(toData, includeCurrentData, currentDataKeys) {
            if (currentDataKeys)
                toData = Navigation.StateContext.includeCurrentData(toData, currentDataKeys.trim().split(/\s*,\s*/));
            if (includeCurrentData)
                toData = Navigation.StateContext.includeCurrentData(toData);
            return toData;
        }
            
        function navigationLink(attributes, children) {
            var newAttributes = {};
            var link = Navigation.StateController.getNavigationLink(attributes.action, attributes.toData);
            newAttributes.href = Navigation.settings.historyManager.getHref(link);
            return a(newAttributes, children);
        }
        
        function refreshLink(attributes, children) {
            var newAttributes = {};
            var toData = getData(attributes.toData, attributes.includeCurrentData, attributes.currentDataKeys);
            var link = Navigation.StateController.getRefreshLink(toData);
            newAttributes.href = Navigation.settings.historyManager.getHref(link);
            return a(newAttributes, children);
        }
        
        function navigationBackLink(attributes, children) {
            var newAttributes = {};
            var link = Navigation.StateController.getNavigationBackLink(attributes.distance);
            newAttributes.href = Navigation.settings.historyManager.getHref(link);
            return a(newAttributes, children);
        }

        Cycle.run(main, {
            DOM: CycleDOM.makeDOMDriver('#content'),
            Navigation: NavigationDriver
        });        
    </script>
</body>
</html>
